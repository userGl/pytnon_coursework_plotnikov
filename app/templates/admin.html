{% extends "base.html" %}

{% block content %}
<h2>Панель администратора</h2>

<div class="btn-group mb-3">
    <button class="btn btn-primary active" onclick="openTab(event, 'logs')">Логи</button>
    <button class="btn btn-primary" onclick="openTab(event, 'tests')">Тесты</button>
    <button class="btn btn-primary" onclick="openTab(event, 'email-settings')">Настройки Email</button>
</div>

<!-- Логи -->
<div id="logs" class="tab-content">
    <h3>Логи системы</h3>
    <button onclick="refreshLogs()" class="btn btn-secondary mb-3">Обновить</button>
    <pre class="bg-light p-3" style="max-height: 500px; overflow: auto;" id="log-content"></pre>
</div>

<!-- Тесты -->
<div id="tests" class="tab-content" style="display: none;">
    <h3>Запуск тестов</h3>
    <div class="mb-3">
        <button onclick="runTests('all')" class="btn btn-primary me-2">Все тесты</button>
        <button onclick="runTests('endpoints')" class="btn btn-primary me-2">Тесты endpoints</button>
        <button onclick="runTests('ocr')" class="btn btn-primary me-2">Тесты OCR</button>
        <button onclick="runTests('repository')" class="btn btn-primary">Тесты репозитория</button>
    </div>
    <pre id="testResults" class="bg-light p-3" style="max-height: 500px; overflow: auto;"></pre>
</div>

<!-- Настройки Email -->
<div id="email-settings" class="tab-content" style="display: none;">
    <h3>Настройки SMTP</h3>
    <form id="emailForm" style="max-width: 400px;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px;">SMTP сервер:</label>
            <input type="text" class="form-control" id="smtp_server" value="{{ email_config.smtp_server if email_config else '' }}" required>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px;">SMTP порт:</label>
            <input type="number" class="form-control" id="smtp_port" value="{{ email_config.smtp_port if email_config else '' }}" required>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px;">SMTP пользователь:</label>
            <input type="text" class="form-control" id="smtp_user" value="{{ email_config.smtp_user if email_config else '' }}" required>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px;">SMTP пароль:</label>
            <input type="password" class="form-control" id="smtp_password" value="{{ email_config.smtp_password if email_config else '' }}" required>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px;">Email отправителя:</label>
            <input type="email" class="form-control" id="from_email" value="{{ email_config.from_email if email_config else '' }}" required>
        </div>
        <button type="submit" class="btn btn-primary">Сохранить</button>
    </form>
</div>

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    
    tablinks = document.getElementsByClassName("btn");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.getElementById('emailForm').onsubmit = function(e) {
    e.preventDefault();
    const data = {
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: parseInt(document.getElementById('smtp_port').value),
        smtp_user: document.getElementById('smtp_user').value,
        smtp_password: document.getElementById('smtp_password').value,
        from_email: document.getElementById('from_email').value
    };

    fetch('/admin/email_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            alert('Настройки сохранены');
        } else {
            alert('Ошибка: ' + result.error);
        }
    });
};

function refreshLogs() {
    fetch('/admin/logs')
        .then(response => response.json())
        .then(data => {
            document.getElementById('log-content').textContent = data.logs;
        });
}

function runTests(type) {
    const resultsContainer = document.getElementById('testResults');
    resultsContainer.textContent = 'Запуск тестов...';
    
    fetch(`/run_test/${type}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultsContainer.textContent = 'Ошибка: ' + data.error;
            } else {
                resultsContainer.textContent = data.output;
            }
        })
        .catch(error => {
            resultsContainer.textContent = 'Ошибка: ' + error;
        });
}

// Показываем первую вкладку (логи) при загрузке
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('logs').style.display = 'block';
    refreshLogs();
});
</script>
{% endblock %} 