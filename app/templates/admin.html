{% extends "base.html" %}

{% block content %}
<h2>Административная панель</h2>

<!-- Секция настройки email -->
<div class="email-section">
    <h3>Настройки SMTP</h3>
    <form id="emailConfigForm">
        <label for="smtp_server">SMTP сервер:</label>
        <input type="text" id="smtp_server" name="smtp_server" value="{{ email_config.smtp_server if email_config else '' }}" required>
        <br><br>

        <label for="smtp_port">SMTP порт:</label>
        <input type="text" id="smtp_port" name="smtp_port" value="{{ email_config.smtp_port if email_config else '' }}" required>
        <br><br>

        <label for="smtp_user">SMTP пользователь:</label>
        <input type="text" id="smtp_user" name="smtp_user" value="{{ email_config.smtp_user if email_config else '' }}" required>
        <br><br>

        <label for="smtp_password">SMTP пароль:</label>
        <input type="password" id="smtp_password" name="smtp_password" value="{{ email_config.smtp_password if email_config else '' }}" required>
        <br><br>

        <label for="from_email">Email отправителя:</label>
        <input type="email" id="from_email" name="from_email" value="{{ email_config.from_email if email_config else '' }}" required>
        <br><br>

        <button type="button" onclick="saveEmailConfig()">Сохранить настройки</button>
    </form>
</div>

<hr>

<!-- Секция тестирования -->
<div class="test-section">
    <h3>Запуск тестов</h3>
    <button onclick="runTest('all')">Все тесты</button>
    <button onclick="runTest('endpoints')">Тесты эндпоинтов</button>
    <button onclick="runTest('repository')">Тесты репозитория</button>
    <button onclick="runTest('ocr')">Тесты OCR</button>
    <div id="testResult" style="white-space: pre-wrap;"></div>
</div>

<script>
    async function saveEmailConfig() {
        const formData = {
            smtp_server: document.getElementById('smtp_server').value,
            smtp_port: parseInt(document.getElementById('smtp_port').value),
            smtp_user: document.getElementById('smtp_user').value,
            smtp_password: document.getElementById('smtp_password').value,
            from_email: document.getElementById('from_email').value
        };

        try {
            const response = await fetch('/admin/email_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                alert('Настройки SMTP сохранены');
            } else {
                alert('Ошибка при сохранении настроек');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при сохранении настроек');
        }
    }

    async function runTest(testType) {
        const resultDiv = document.getElementById('testResult');
        resultDiv.textContent = 'Выполняется...';
        try {
            const response = await fetch(`/run_test/${testType}`);
            const data = await response.json();
            resultDiv.textContent = data.output || data.error;
        } catch (error) {
            resultDiv.textContent = 'Ошибка при выполнении тестов: ' + error;
        }
    }
</script>
{% endblock %} 