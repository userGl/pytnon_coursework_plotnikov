## "Микросервис для анализа текста на изображениях (OCR)"
### Курсовая работа студента ТГУ Плотникова Г.А. по предмету "Программирование на Python: углубленный курс"

## 1. Обязательная часть:  
### 1.1. Этапы работа над проектом (общие для всех проектов).  
**Анализ требований:**  
• Определение функциональных требований (обработка изображений с распознаванием лиц).  
• Выбор технологии для распознавания лиц (например, OpenCV или Dlib).  
• Разработка API для получения изображений от пользователей.  
**Разработка backend:**  
• Создание FastAPI сервиса для приема и обработки изображений.  
• Реализация функционала для распознавания лиц с использованием библиотеки OpenCV.  
• Применение паттерна Singleton для управления моделью распознавания лиц.  
**Работа с базой данных:**  
• Проектирование структуры базы данных для хранения изображений и результатов распознавания. 
• Реализация CRUD операций для сохранения и извлечения данных.
**Тестирование и валидация:**  
• Тестирование работы сервиса с различными изображениями.  
• Валидация корректности данных, передаваемых через API  
**Документация и развертывание:**  
• Документирование API и сервиса  

### 1.2. Заданиe на курсовой проект:  
**Решаемые задачи:**   
• Использование библиотеки Tesseract для OCR.  
• Создание API с использованием FastAPI.  
• Валидация данных (Проверка, что изображение содержит текст).  
• Хранение результатов в базе данных и отображение их через frontend.  
Сервис организован на базе web фреймворка FastAPI и Tesseract.  

### 1.3. Инструкции преподавателя от 11.01.2025 (требования для всех проектов):
• **Описание в Readme (что за проект, для чего, как работает, как установить и запустить). - Выполнено**  
• **Использование паттернов программирования. - Выполнено репозиторий**  
• **Тестирование. - Выполнено**  
• **Разделение проекта, структурирование. - Выполнено**  
• **Валидация. - Выполнено**  
• **Шаблоны HTML (рекомендуется не менее 3). - Выполнено**  
• **Наследование шаблонов HTML от базового шаблона base.html - Выполнено**  
• Pandas, если есть смысл его использовать.  
• **Реализация API (чтобы можно было обратиться как с  помощью скрипта, так и со странички HTML). - Выполнено**  

### 1.4. Инструкции преподавателя к текущему проекту от 23.12.2024:
Здравствуйте, в целом мне ваш проект понятен. Было бы здорово если бы вы описали несколько сценариев работы вашего проекта. Какие действия нужно совершить пользователю для решения задачи. 
Например, для распознавания тектса документа на русском языке пользользователь должен вполнить следующие действия:   
1.4.1. Авторизваться/открыть сервис.  
1.4.2. Перейти на страницу загрузки документа для распознавания текста.  
1.4.3. Загрузить документ с изображения в формате jpg.  
1.4.4. Сервис сохраняет загруженный документ в директорию "temp".  
1.4.5. Сервис выполняет проверку документа на корректность и в случае успеха запускает процесс распознавания текста.  
1.4.6. В результате обработки документа пользователь получает на почту тестовый документ в формате ".docx" в котором находится распознанный текст загруженного документа.  
1.4.7. Рекомендую добавить систему логирования чтоб администратор мог просматривать в виде таблицы статистику использования сервиса. Например, названия загруженных документов, размер документа, дату и время загрузки, время обработки документа, имя клиента и почту на которую был выслан результат.  

## 2. Структура проекта
```
project_root/
├── app/                    # Основной код приложения
│   ├── main.py            # FastAPI приложение
│   ├── tesseract.py       # Модуль работы с OCR
│   └── templates/         # HTML шаблоны
│       ├── base.html      # Базовый шаблон
│       ├── about.html     # Страница "О проекте"
│       ├── admin.html     # Админ-панель
│       ├── ocr.html       # Главная страница OCR
│       └── search.html    # Страница поиска
│
├── repository/            # Работа с базой данных
│   ├── repository.py     # CRUD операции
│   ├── files/           # Хранилище изображений
│   └── database.db      # SQLite база данных
│
├── notifier/             # Отправка уведомлений
│   └── notification_service.py  # Работа с SMTP
│
├── tests/               # Модульные тесты
│   ├── test_endpoints.py    # Тесты endpoints
│   ├── test_repository.py   # Тесты базы данных
│   ├── test_ocr_server.py   # Тесты OCR
│   ├── conftest.py          # Конфигурация тестов
│   └── tests_data/          # Тестовые файлы
│       ├── test_text_ok_ru.png     # Тест русского текста
│       ├── test_text_ok_en.png     # Тест английского текста
│       ├── test_no_letters.png     # Изображение без текста
│       ├── test_wrong_type.txt     # Неверный формат файла
│       └── test_empy_pict.png      # Пустое изображение
│
├── logs/                # Директория для логов
│   └── ocr_app_*.log   # Файлы логов
│
├── Tesseract-OCR/      # Папка с установленным Tesseract
├── logger_config.py    # Конфигурация системы логирования
├── requirements.txt    # Зависимости Python
└── README.md          # Документация проекта
```

## 3. Установка программы Windows
3.1. Работа программы проверялась на Python 3.13.0  
3.2. Склонируйте файлы этого проекта в папку на компьютере. Не используйте кириллицу в пути к папке.  
3.3. Установите виртуальное окружениеие и зависимости. Запустите командную строку в скаченной папке проекта и выполните:  
• python -m venv env  
• env\Scripts\activate  
• pip install -r requirements.txt  
3.4. Скачайте инсталятор "tesseract-ocr-w64-setup-5.5.0.20241111.exe" с сайта:  
https://github.com/UB-Mannheim/tesseract/wiki  
3.5. Запустите инсталятор и в процессе установки выберите:  
• "Additional language data"(download) в меню "Компоненты устанавливаемой программы" выберите требуемые дополнительные языки (как минимум, русский) 
•  В меню "Выбор папки установки" выберите папку "Tesseract-OCR" которая находится в папке проекта  программы (см. пункт 3.2).   

#### 4. Запуск программы  
Запустите командную строку в скаченной папке проекта и выполните:  
4.1. Активируйте витуальное окружение: Запустите командную строку в папке проекта и выполните env/Scripts/activate  
4.2. Запустите web-сервер, в виртуальном окружении выполните: uvicorn app.main:app  
4.3. Для работы с программой в браузере откройте http://127.0.0.1:8000 

#### 5. Работа с микросервисом
##### 5.1. OCR
• GET /OCR/get_languages/ - Получение списка поддерживаемых языков
• POST /OCR/upload/ - Загрузка и распознавание файла

Примеры:
```bash
# Получение списка языков
curl http://localhost:8000/OCR/get_languages/

# Загрузка файла на распознавание
curl -F "file=@image.png" -F "lang=rus" http://localhost:8000/OCR/upload/
```

##### 5.2. Records (Записи)
• GET /records/ - HTML страница поиска записей
• GET /records/search - API для поиска записей
• POST /records/delete - API для удаления записей

Примеры:
```bash
# Получение всех записей
curl http://localhost:8000/records/search

# Поиск по тексту (с URL-кодированием для русских букв)
curl -G "http://localhost:8000/records/search" --data-urlencode "keyword=тест"

# Поиск по имени файла
curl "http://localhost:8000/records/search?filename=ok"

# Поиск по дате
curl "http://localhost:8000/records/search?date_to=2025-02-16"
```

##### 5.3. Email
• POST /notifier/send_email/ - Отправка текста на email

Пример:
```bash
# Отправка текста на email
curl -X POST http://localhost:8000/notifier/send_email/ -H "Content-Type: application/json" -d '{"text": "Текст для отправки", "to_email": "user@example.com"}'
```

##### 5.4. Логи
• GET /admin/logs - Получение логов системы

Пример:
```bash
# Получение последних 50 строк лога
curl http://localhost:8000/admin/logs?lines=50
```

##### 5.5. Тестирование
• GET /admin/run_test/{test_type} - Запуск тестов

Примеры:
```bash
# Запуск тестов OCR
curl http://localhost:8000/admin/run_test/ocr

# Запуск тестов endpoints
curl http://localhost:8000/admin/run_test/endpoints

# Запуск тестов repository
curl http://localhost:8000/admin/run_test/repository

# Запуск всех тестов
curl http://localhost:8000/admin/run_test/all
```

##### 5.6. Настройка SMTP
• POST /admin/email_config - Настройка SMTP сервера

Пример:
```bash
# Настройка SMTP
curl -X POST http://localhost:8000/admin/email_config -H "Content-Type: application/json" -d "{\"smtp_server\": \"smtp.mail.ru\", \"smtp_port\": 465, \"smtp_user\": \"your.login@mail.ru\", \"smtp_password\": \"your-app-password\", \"from_email\": \"your.login@mail.ru\"}"
```

#### 6. Тестирование
В проекте есть 3 группы тестов:  

##### 6.1. Тесты endpoints (tests/test_endpoints.py):  
• Тесты HTML страниц:
    • GET /about/ - страница с описанием проекта
    • GET /admin/ - страница администратора
    • GET / - страница OCR
• Тест API:
    • GET /records/search - доступность endpoint поиска записей

##### 6.2. Тесты базы данных (tests/test_repository.py):  
• Тест добавления записи в БД
• Тест удаления записи из БД

##### 6.3. Тесты OCR (tests/test_ocr_server.py):  
• Тесты распознавания разных типов файлов:
    • test_text_ok_ru.png: ожидается успешное распознавание русского текста
    • test_text_ok_en.png: ожидается успешное распознавание английского текста
    • test_no_letters.png: ожидается ошибка "текст слишком короткий или не содержит букв"
    • test_wrong_type.txt: ожидается ошибка "неправильный формат файла"
    • test_empy_pict.png: ожидается ошибка "текст слишком короткий или не содержит букв"
• После каждого теста:
    • Проверяется статус ответа
    • Сравнивается результат с ожидаемым
    • Очищаются тестовые данные из БД

##### 6.4. Запуск тестов:  
• Через веб-интерфейс на странице "АДМИН":
    • По отдельности, выбрав нужный тест
    • Все вместе, нажав "Запустить все тесты"
• Через API микросервиса:
    • GET /admin/run_test/endpoints - запуск тестов endpoints
    • GET /admin/run_test/ocr - запуск тестов OCR
    • GET /admin/run_test/repository - запуск тестов repository
    • GET /admin/run_test/all - запуск всех тестов
• Из командной строки:
    • Все тесты: pytest
    • Конкретный тест: pytest tests/test_имя_файла.py
